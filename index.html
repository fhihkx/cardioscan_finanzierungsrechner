<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cardioscan Finance Calculator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PURE jsPDF Library (Ersetzt html2pdf für ausfallsicheres Vektor-PDF Rendering) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- EmailJS Library für den sicheren E-Mail-Versand -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("y0ANsvoTYHNRXCf5R");
        })();
    </script>
    
    <!-- Fonts: Montserrat (Headings) & Open Sans (Body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cs: {
                            blue: '#2c62f2',      // Primary Blue
                            blueHover: '#1a4bd6',
                            navy: '#0b1c33',      // Dark Navy Background
                            text: '#0b1c33',      // Main Text Color
                            light: '#F8F9FB',     // Page Background
                            border: '#E6E9F0'
                        }
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        body: ['Open Sans', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 20px 60px -15px rgba(11, 28, 51, 0.12)',
                        'glow': '0 0 40px rgba(44, 98, 242, 0.3)',
                        'inner-light': 'inset 0 1px 0 rgba(255,255,255,0.1)'
                    },
                    borderRadius: {
                        '3xl': '24px',
                        '4xl': '32px'
                    },
                    transitionProperty: {
                        'height': 'height, max-height'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Open Sans', sans-serif; background-color: #F8F9FB; color: #0b1c33; overflow-x: hidden; }
        h1, h2, h3, h4, .font-heading { font-family: 'Montserrat', sans-serif; }

        /* Navigation Style */
        .nav-item {
            font-weight: 700;
            font-size: 14px;
            color: #0b1c33;
            letter-spacing: 0.02em; 
            transition: color 0.2s;
        }
        .nav-item:hover { color: #2c62f2; }

        /* Tab Buttons */
        .tab-nav {
            background: #fff;
            padding: 9px; 
            border-radius: 14px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.05);
            display: inline-flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 7px; 
        }
        .tab-btn {
            padding: 20px 56px; 
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 18px; 
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }
        .tab-btn.active {
            background: #2c62f2;
            color: #fff;
            box-shadow: 0 4px 15px rgba(44, 98, 242, 0.3);
            transform: scale(1.02);
        }
        .tab-btn:hover:not(.active) {
            color: #2c62f2;
            background: #F0F5FF;
        }

        /* Calculator Specifics */
        .calc-input-wrapper {
            background: #F8F9FB;
            border: 2px solid #E6E9F0;
            border-radius: 8px;
            padding: 12px 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .calc-input-wrapper:focus-within {
            border-color: #2c62f2;
            background: #fff;
            box-shadow: 0 0 0 4px rgba(44, 98, 242, 0.1);
            transform: translateY(-2px);
        }
        .calc-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: #0b1c33;
            font-size: 20px;
            padding: 4px 0;
        }
        
        /* HIDE INPUT SPINNERS (Arrows) */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield;
        }

        .calc-label {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 8px;
            display: block;
        }

        /* Form Inputs (Step 2) */
        .form-input {
            width: 100%;
            background-color: #F8F9FB;
            border: 2px solid #E6E9F0;
            border-radius: 8px;
            padding: 12px 16px;
            font-weight: 600;
            color: #0b1c33;
            outline: none;
            transition: all 0.2s;
        }
        .form-input:focus {
            border-color: #2c62f2;
            background-color: #fff;
        }

        /* Container Height Transition */
        #content-container {
            transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Helper for Step Transitions within Calculator */
        .step-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .hidden-step {
            display: none;
            opacity: 0;
            pointer-events: none;
        }
        .active-step {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        /* Mobile Adjustments */
        @media (max-width: 640px) {
            .tab-btn { padding: 16px 32px; font-size: 14px; width: 100%; }
            .tab-nav { border-radius: 12px; width: 100%; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- HEADER -->
    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-50 border-b border-gray-100 transition-all duration-300">
        <div class="max-w-[1400px] mx-auto px-6 md:px-8 py-4 flex items-center justify-between">
            <a href="https://cardioscan.de" target="_blank" class="flex items-center group shrink-0">
                <img src="cardioscan_logo.png" alt="cardioscan Logo" class="h-12 md:h-16 lg:h-20 object-contain group-hover:opacity-80 transition-opacity">
            </a>
            <div class="flex items-center gap-6">
                <a href="https://cardioscan.de/vertrieb-kontaktieren" target="_blank" class="bg-cs-blue text-white px-6 py-3 rounded-md text-sm font-bold uppercase tracking-wide hover:bg-blue-600 transition-colors shadow-md whitespace-nowrap">
                    VERTRIEB KONTAKTIEREN
                </a>
            </div>
        </div>
    </header>

    <!-- HERO -->
    <section class="pt-16 pb-12 px-6 text-center">
        <h1 class="text-4xl md:text-6xl font-extrabold text-cs-navy mb-6 tracking-tight">Smart Finance</h1>
        <p class="text-lg text-slate-500 max-w-2xl mx-auto">
            Investieren Sie in die Zukunft Ihrer Kunden. <br class="hidden md:block">
            Flexibel, transparent und ohne Kapitalbindung.
        </p>
    </section>

    <!-- MAIN APP AREA -->
    <main class="w-full max-w-6xl mx-auto px-4 md:px-6 pb-24 relative z-10">
        
        <!-- Tab Navigation -->
        <div class="flex justify-center mb-12">
            <div class="tab-nav">
                <button onclick="switchTab('calculator')" id="tab-calculator" class="tab-btn active">Rechner</button>
                <button onclick="switchTab('why')" id="tab-why" class="tab-btn">Ihre Vorteile</button>
            </div>
        </div>

        <!-- CONTENT CONTAINER (Dynamic Height) -->
        <div id="content-container" class="relative w-full overflow-visible">
            
            <!-- VIEW 1: CALCULATOR -->
            <div id="view-calculator" class="view-content absolute inset-x-0 top-0 w-full opacity-100 transition-all duration-500 z-10">
                <div class="bg-white rounded-xl shadow-card overflow-hidden border border-gray-100 lg:h-auto relative">
                    
                    <!-- STEP 1: CALCULATION -->
                    <div id="calc-step-1" class="flex flex-col lg:flex-row h-full active-step w-full transition-opacity duration-300">
                        <div class="w-full lg:w-7/12 p-8 md:p-10 lg:p-12 flex flex-col justify-center">
                            <div class="flex items-center justify-between mb-8">
                                <h2 class="text-3xl md:text-4xl font-extrabold text-cs-navy font-heading">Finanzierungsrechner</h2>
                            </div>

                            <div class="space-y-8 w-full">
                                <div>
                                    <label class="calc-label">Anschaffungspreis (Netto)</label>
                                    <div class="calc-input-wrapper">
                                        <span class="text-gray-400 font-bold mr-4 text-xl">€</span>
                                        <input type="text" id="price" class="calc-input" placeholder="0,00" inputmode="decimal" oninput="formatPriceInput(this)">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <div>
                                        <label class="calc-label">Laufzeit</label>
                                        <div class="calc-input-wrapper relative">
                                            <select id="duration" class="calc-input appearance-none cursor-pointer bg-transparent w-full pr-8" onchange="updateResidualOptions()">
                                                <option value="" disabled selected>Bitte wählen</option>
                                                <option value="48">48 Monate</option>
                                                <option value="54">54 Monate</option>
                                                <option value="60">60 Monate</option>
                                            </select>
                                            <div class="absolute right-5 text-cs-blue pointer-events-none">
                                                <i class="fa-solid fa-chevron-down text-sm"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="calc-label">Restwert</label>
                                        <div class="calc-input-wrapper relative">
                                            <select id="residual" class="calc-input appearance-none cursor-pointer bg-transparent w-full pr-8">
                                                <option value="" disabled selected>Bitte wählen</option>
                                                <option value="5">5 %</option>
                                                <option value="10">10 %</option>
                                                <option value="15">15 %</option>
                                            </select>
                                            <div class="absolute right-5 text-cs-blue pointer-events-none">
                                                <i class="fa-solid fa-chevron-down text-sm"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="pt-2">
                                    <button onclick="calculate()" class="w-full bg-cs-navy text-white font-bold py-5 rounded-lg text-sm hover:bg-cs-blue transition-all shadow-xl hover:shadow-glow hover:-translate-y-1 flex justify-center items-center gap-3 group">
                                        Rate berechnen 
                                        <i class="fa-solid fa-calculator group-hover:rotate-12 transition-transform"></i>
                                    </button>
                                </div>

                                <div id="error-msg" class="hidden p-4 rounded-lg bg-red-50 border border-red-100 flex items-start md:items-center gap-4 text-red-600 text-sm font-medium animate-pulse">
                                    <i class="fa-solid fa-circle-exclamation text-xl mt-0.5 md:mt-0"></i>
                                    <span id="error-text">Diese Kombination ist aktuell nicht verfügbar.</span>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT: Result Step 1 -->
                        <div class="w-full lg:w-5/12 bg-cs-navy p-8 md:p-10 lg:p-12 text-white flex flex-col relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-96 h-96 bg-cs-blue opacity-10 rounded-full blur-[80px] transform translate-x-1/2 -translate-y-1/2"></div>
                            <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-400 opacity-5 rounded-full blur-[60px]"></div>
                            
                            <div class="relative z-10 flex flex-col h-full justify-center">
                                <div class="mb-4">
                                    <div class="inline-block px-4 py-1.5 rounded-md border border-white/20 bg-white/5 text-[10px] font-bold uppercase tracking-widest mb-10 backdrop-blur-sm">
                                        Unverbindliches Angebot
                                    </div>

                                    <div class="text-white/60 font-heading text-sm mb-2 font-bold">Monatliche Rate</div>
                                    <div class="text-6xl md:text-7xl font-extrabold tracking-tighter mb-4 break-words" id="result-display">0,00 €</div>
                                    
                                    <div class="text-[11px] text-white/30 leading-relaxed max-w-sm mt-28">
                                        *Alle Preise zzgl. gesetzlicher MwSt. vorbehaltlich positiver Bonitätsprüfung durch unsere Finanzierungspartner.
                                    </div>
                                </div>

                                <div class="mt-auto self-end pt-8">
                                    <button onclick="goToStep(2)" id="btn-next" class="w-14 h-14 bg-white text-cs-navy rounded-full flex items-center justify-center text-xl hover:bg-cs-blue hover:text-white transition-all shadow-lg hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:hover:bg-white disabled:hover:text-cs-navy" disabled>
                                        <i class="fa-solid fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: CONTACT FORM -->
                    <div id="calc-step-2" class="hidden-step flex-col lg:flex-row h-full w-full transition-opacity duration-300">
                        <div class="w-full lg:w-7/12 p-8 md:p-10 lg:p-12 flex flex-col justify-center">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-3xl font-extrabold text-cs-navy font-heading">Kontaktdaten</h2>
                            </div>
                            <p class="text-slate-500 mb-8 text-sm">Bitte geben Sie Ihre Daten ein, um das unverbindliche Angebot als PDF zu erhalten.</p>

                            <form class="space-y-4 w-full" id="contact-form" onsubmit="event.preventDefault(); downloadOfferPDF();">
                                <div>
                                    <label class="calc-label">Finanzierungsart</label>
                                    <div class="relative">
                                        <select id="form-finanzierungsart" class="form-input appearance-none cursor-pointer pr-8" required>
                                            <option value="" disabled selected>Wählen</option>
                                            <option value="Leasing">Leasing</option>
                                            <option value="Mietkauf">Mietkauf</option>
                                        </select>
                                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-cs-blue pointer-events-none">
                                            <i class="fa-solid fa-chevron-down text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="calc-label">Anrede</label>
                                    <div class="relative">
                                        <select id="form-anrede" class="form-input appearance-none cursor-pointer pr-8" required>
                                            <option value="" disabled selected>Wählen</option>
                                            <option value="Frau">Frau</option>
                                            <option value="Herr">Herr</option>
                                        </select>
                                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-cs-blue pointer-events-none">
                                            <i class="fa-solid fa-chevron-down text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="calc-label">Vorname</label>
                                        <input type="text" id="form-vorname" class="form-input" required>
                                    </div>
                                    <div>
                                        <label class="calc-label">Nachname</label>
                                        <input type="text" id="form-nachname" class="form-input" required>
                                    </div>
                                </div>

                                <div>
                                    <label class="calc-label">Firmenname</label>
                                    <input type="text" id="form-firma" class="form-input" required>
                                </div>

                                <div>
                                    <label class="calc-label">Adresse & Hausnummer</label>
                                    <input type="text" id="form-strasse" class="form-input" required>
                                </div>

                                <div class="grid grid-cols-3 gap-4">
                                    <div class="col-span-1">
                                        <label class="calc-label">Postleitzahl</label>
                                        <input type="text" id="form-plz" class="form-input" required>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="calc-label">Ort</label>
                                        <input type="text" id="form-ort" class="form-input" required>
                                    </div>
                                </div>

                                <!-- Neue Checkbox für Datenschutz (optional aber empfohlen bei E-Mail Versand) -->
                                <div class="pt-2">
                                    <label class="flex items-start gap-3 text-xs text-slate-500 cursor-pointer">
                                        <input type="checkbox" required class="mt-0.5 border-gray-300 rounded text-cs-blue focus:ring-cs-blue">
                                        <span>Ich stimme zu, dass meine Daten zur Erstellung des Angebots verarbeitet und eine Kopie an den cardioscan Vertrieb gesendet wird.</span>
                                    </label>
                                </div>

                                <div class="pt-4">
                                    <button type="submit" id="submit-btn" class="w-full bg-cs-navy text-white font-bold py-5 rounded-lg text-sm hover:bg-cs-blue transition-all shadow-xl hover:shadow-glow hover:-translate-y-1 flex justify-center items-center gap-3">
                                        <span>Angebot herunterladen</span>
                                        <i class="fa-solid fa-download"></i>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- RIGHT: Summary Step 2 -->
                        <div class="w-full lg:w-5/12 bg-cs-navy p-8 md:p-10 lg:p-12 text-white flex flex-col justify-center relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-96 h-96 bg-cs-blue opacity-10 rounded-full blur-[80px] transform translate-x-1/2 -translate-y-1/2"></div>
                            <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-400 opacity-5 rounded-full blur-[60px]"></div>
                            
                            <div class="relative z-10 flex flex-col h-full">
                                <h3 class="font-heading font-bold text-2xl mb-8">Ihre Finanzierung</h3>
                                
                                <div class="space-y-4 text-sm flex-grow">
                                    <div class="flex justify-between border-b border-white/10 pb-3">
                                        <span class="text-white/60">Anschaffungspreis</span>
                                        <span class="font-bold" id="summary-price">0,00 €</span>
                                    </div>
                                    <div class="flex justify-between border-b border-white/10 pb-3">
                                        <span class="text-white/60">Laufzeit</span>
                                        <span class="font-bold"><span id="summary-duration">0</span> Monate</span>
                                    </div>
                                    <div class="flex justify-between border-b border-white/10 pb-3">
                                        <span class="text-white/60">Anzahlung</span>
                                        <span class="font-bold">0,00 €</span>
                                    </div>
                                    <div class="flex justify-between border-b border-white/10 pb-3">
                                        <span class="text-white/60">Restwert</span>
                                        <span class="font-bold" id="summary-residual-euro">0,00 €</span>
                                    </div>
                                    <div class="flex justify-between border-b border-white/10 pb-3">
                                        <span class="text-white/60">Leasingfaktor</span>
                                        <span class="font-bold" id="summary-leasing-factor">0,00 %</span>
                                    </div>
                                </div>

                                <div class="mt-12">
                                    <div class="text-white/60 font-heading text-xs mb-1 font-bold uppercase tracking-widest">Monatliche Rate</div>
                                    <div class="text-5xl font-extrabold tracking-tighter" id="summary-rate">0,00 €</div>
                                </div>

                                <div class="mt-10">
                                    <button onclick="goToStep(1)" class="text-white/60 hover:text-white text-sm font-bold flex items-center gap-2 transition-colors">
                                        <i class="fa-solid fa-arrow-left"></i> Zurück zur Berechnung
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIEW 2: BENEFITS -->
            <div id="view-why" class="view-content absolute inset-x-0 top-0 w-full opacity-0 pointer-events-none transition-all duration-300">
                <div class="bg-white rounded-xl shadow-card p-8 md:p-16 lg:p-24 border border-gray-100 flex flex-col justify-center">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl md:text-4xl font-bold text-cs-navy mb-4 font-heading">Warum Finanzierung?</h2>
                        <p class="text-slate-500 text-lg">Intelligentes Wachstum für Ihr Business.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="p-8 md:p-10 rounded-xl bg-gray-50 border border-transparent hover:border-cs-blue hover:bg-white hover:shadow-xl transition-all duration-300 group">
                            <div class="w-20 h-20 bg-white rounded-lg flex items-center justify-center text-cs-blue text-3xl shadow-sm mb-8 group-hover:bg-cs-blue group-hover:text-white transition-colors">
                                <i class="fa-solid fa-wallet"></i>
                            </div>
                            <h3 class="font-bold text-2xl mb-4 text-cs-navy">Liquidität</h3>
                            <p class="text-base text-slate-500 leading-relaxed">Keine hohe Einmalinvestition. Sie behalten Ihr Kapital für das operative Geschäft.</p>
                        </div>
                        <div class="p-8 md:p-10 rounded-xl bg-gray-50 border border-transparent hover:border-cs-blue hover:bg-white hover:shadow-xl transition-all duration-300 group">
                            <div class="w-20 h-20 bg-white rounded-lg flex items-center justify-center text-cs-blue text-3xl shadow-sm mb-8 group-hover:bg-cs-blue group-hover:text-white transition-colors">
                                <i class="fa-solid fa-chart-line"></i>
                            </div>
                            <h3 class="font-bold text-2xl mb-4 text-cs-navy">Planbarkeit</h3>
                            <p class="text-base text-slate-500 leading-relaxed">Konstante, feste Raten über die gesamte Laufzeit erleichtern Ihre Budgetplanung.</p>
                        </div>
                        <div class="p-8 md:p-10 rounded-xl bg-gray-50 border border-transparent hover:border-cs-blue hover:bg-white hover:shadow-xl transition-all duration-300 group">
                            <div class="w-20 h-20 bg-white rounded-lg flex items-center justify-center text-cs-blue text-3xl shadow-sm mb-8 group-hover:bg-cs-blue group-hover:text-white transition-colors">
                                <i class="fa-solid fa-rocket"></i>
                            </div>
                            <h3 class="font-bold text-2xl mb-4 text-cs-navy">Innovation</h3>
                            <p class="text-base text-slate-500 leading-relaxed">Nutzen Sie immer die neueste Diagnostik-Technologie durch flexible Upgrades.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <footer class="bg-white border-t border-gray-100 py-12 mt-auto relative z-20">
        <div class="max-w-[1400px] mx-auto px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <a href="https://cardioscan.de" target="_blank" class="flex items-center gap-2 group">
                <img src="cardioscan_logo.png" alt="cardioscan Logo" class="h-10 md:h-14 object-contain group-hover:opacity-80 transition-opacity">
            </a>
            <div class="flex items-center gap-6 md:gap-8 text-sm font-medium text-cs-navy">
                <a href="https://cardioscan.de/agb" target="_blank" class="hover:text-cs-blue transition-colors">AGB</a>
                <a href="https://cardioscan.de/datenschutz" target="_blank" class="hover:text-cs-blue transition-colors">Datenschutz</a>
                <a href="https://cardioscan.de/impressum" target="_blank" class="hover:text-cs-blue transition-colors">Impressum</a>
            </div>
        </div>
    </footer>

    <!-- LOGIC -->
    <script>
        const factors = {
            "15": { "48": 2.20, "54": 1.99, "60": null },
            "10": { "48": 2.29, "54": 2.07, "60": null },
            "5":  { "48": 2.39, "54": 2.15, "60": 1.97 }
        };

        window.addEventListener('load', () => {
            switchTab('calculator');
        });

        window.addEventListener('resize', () => {
            const activeBtn = document.querySelector('.tab-btn.active');
            if(activeBtn) {
                const id = activeBtn.id.replace('tab-', '');
                adjustContainerHeight(id);
            }
        });

        function adjustContainerHeight(tabId) {
            const container = document.getElementById('content-container');
            const activeView = document.getElementById('view-' + tabId);
            if(activeView) {
                container.style.height = activeView.offsetHeight + 'px';
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.id === 'tab-' + tabId) btn.classList.add('active');
            });

            document.querySelectorAll('.view-content').forEach(view => {
                view.style.opacity = '0';
                view.style.pointerEvents = 'none';
                view.style.zIndex = '0';
            });

            const activeView = document.getElementById('view-' + tabId);
            if(activeView) {
                activeView.style.opacity = '1';
                activeView.style.pointerEvents = 'auto';
                activeView.style.zIndex = '10';
                setTimeout(() => adjustContainerHeight(tabId), 10);
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value);
        }

        function formatPriceInput(input) {
            let val = input.value.replace(/\./g, '');
            val = val.replace(/[^\d,]/g, '');
            let parts = val.split(',');
            if (parts.length > 2) {
                parts = [parts[0], parts.slice(1).join('')];
            }
            let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            if (parts.length > 1) {
                input.value = integerPart + ',' + parts[1].substring(0, 2); 
            } else {
                input.value = integerPart;
            }
        }

        function updateResidualOptions() {
            const duration = document.getElementById('duration').value;
            const residualSelect = document.getElementById('residual');
            const options = residualSelect.options;

            for (let i = 0; i < options.length; i++) {
                const val = options[i].value;
                if (duration === "60") {
                    if (val === "10" || val === "15") {
                        options[i].hidden = true;
                        options[i].disabled = true;
                        options[i].style.display = 'none'; 
                    } else {
                        options[i].hidden = false;
                        options[i].disabled = false;
                        options[i].style.display = '';
                    }
                } else {
                     options[i].hidden = false;
                     options[i].disabled = false;
                     options[i].style.display = '';
                }
            }

            if (duration === "60" && (residualSelect.value === "10" || residualSelect.value === "15")) {
                residualSelect.value = "5";
            }
        }

        function calculate() {
            const priceInput = document.getElementById('price').value;
            const duration = document.getElementById('duration').value;
            const residual = document.getElementById('residual').value;
            
            const resultDisplay = document.getElementById('result-display');
            const errorMsg = document.getElementById('error-msg');
            const errorText = document.getElementById('error-text');
            const nextBtn = document.getElementById('btn-next');

            const price = parseFloat(priceInput.replace(/\./g, '').replace(',', '.'));

            if (!duration || !residual) return;

            const factor = factors?.[residual]?.[duration] ?? null;

            if (factor === null) {
                resultDisplay.innerText = "—";
                errorText.innerText = `Diese Kombination (${duration} Monate / ${residual}%) ist aktuell nicht verfügbar.`;
                errorMsg.classList.remove('hidden');
                nextBtn.disabled = true;
            } else {
                errorMsg.classList.add('hidden');
                if (price && price > 0) {
                    const rate = price * (factor / 100);
                    resultDisplay.innerText = formatCurrency(rate);
                    nextBtn.disabled = false;
                } else {
                    resultDisplay.innerText = "0,00 €";
                    nextBtn.disabled = true;
                }
            }
        }

        function goToStep(step) {
            const step1 = document.getElementById('calc-step-1');
            const step2 = document.getElementById('calc-step-2');

            if (step === 2) {
                const priceStr = document.getElementById('price').value || "0";
                const durationVal = document.getElementById('duration').value;
                const residualVal = document.getElementById('residual').value;
                const rateVal = document.getElementById('result-display').innerText;

                const price = parseFloat(priceStr.replace(/\./g, '').replace(',', '.')) || 0;
                const residualEuro = price * (parseFloat(residualVal) / 100);
                const factor = factors[residualVal]?.[durationVal];
                
                const formatFactor = (f) => f ? f.toString().replace('.', ',') + ' %' : '- %';
                const formattedPrice = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(price);

                document.getElementById('summary-price').innerText = formattedPrice + ' €';
                document.getElementById('summary-duration').innerText = durationVal;
                document.getElementById('summary-residual-euro').innerText = formatCurrency(residualEuro);
                document.getElementById('summary-leasing-factor').innerText = formatFactor(factor);
                document.getElementById('summary-rate').innerText = rateVal;

                step1.classList.remove('active-step', 'flex');
                step1.classList.add('hidden-step');
                
                step2.classList.remove('hidden-step');
                step2.classList.add('active-step', 'flex');
            } else {
                step2.classList.remove('active-step', 'flex');
                step2.classList.add('hidden-step');

                step1.classList.remove('hidden-step');
                step1.classList.add('active-step', 'flex');
            }
            setTimeout(() => adjustContainerHeight('calculator'), 50);
        }

        function getBase64Logo() {
            return new Promise((resolve) => {
                fetch('cardioscan_logo.png')
                    .then(response => {
                        if (!response.ok) throw new Error("Logo nicht gefunden");
                        return response.blob();
                    })
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const img = new Image();
                            img.onload = () => {
                                resolve({ data: reader.result, w: img.width, h: img.height });
                            };
                            img.src = reader.result;
                        };
                        reader.readAsDataURL(blob);
                    })
                    .catch(err => {
                        console.warn("Logo konnte nicht geladen werden, Text-Fallback wird genutzt.", err);
                        resolve(null);
                    });
            });
        }

        // --- PURE jsPDF GENERATOR & EMAILJS INTEGRATION ---
        async function downloadOfferPDF() {
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>PDF wird erstellt & gesendet...</span> <i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

                const art = document.getElementById('form-finanzierungsart').value;
                const anrede = document.getElementById('form-anrede').value;
                const vorname = document.getElementById('form-vorname').value;
                const nachname = document.getElementById('form-nachname').value;
                const firma = document.getElementById('form-firma').value;
                const strasse = document.getElementById('form-strasse').value;
                const plz = document.getElementById('form-plz').value;
                const ort = document.getElementById('form-ort').value;

                let salutation = anrede === "Frau" ? `Sehr geehrte Frau ${nachname},` :
                                 anrede === "Herr" ? `Sehr geehrter Herr ${nachname},` :
                                 `Guten Tag ${vorname} ${nachname},`;

                const date = new Date();
                const datum = ('0' + date.getDate()).slice(-2) + '.' + ('0' + (date.getMonth() + 1)).slice(-2) + '.' + date.getFullYear();

                const preisVal = document.getElementById('summary-price').textContent.replace('€', '').trim();
                const laufzeitVal = document.getElementById('summary-duration').textContent.replace('Monate', '').trim();
                const restwertEuroVal = document.getElementById('summary-residual-euro').textContent.replace('€', '').trim();
                let leasingfaktorVal = document.getElementById('summary-leasing-factor').textContent.trim();
                const rateVal = document.getElementById('summary-rate').textContent.replace('€', '').trim();

                const logo = await getBase64Logo();
                if (logo && logo.data) {
                    const maxW = 50; const maxH = 15;
                    let imgW = maxW;
                    let imgH = (logo.h * maxW) / logo.w;
                    if (imgH > maxH) {
                        imgH = maxH;
                        imgW = (logo.w * maxH) / logo.h;
                    }
                    doc.addImage(logo.data, 'PNG', 190 - imgW, 20, imgW, imgH); 
                } else {
                    doc.setFontSize(16); doc.setFont("helvetica", "bold");
                    doc.setTextColor(44, 98, 242);
                    doc.text("cardioscan", 190, 25, { align: "right" });
                    doc.setTextColor(0, 0, 0); 
                }

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text([firma, `${anrede} ${vorname} ${nachname}`, strasse, `${plz} ${ort}`], 20, 45);

                doc.text(`Hamburg, ${datum}`, 190, 60, { align: "right" });

                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text(`Finanzierungsangebot: ${art}`, 20, 80);

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(salutation, 20, 95);
                doc.text("vielen Dank für das entgegengebrachte Vertrauen! Wie folgt bieten wir Ihnen unverbindlich an:", 20, 105);

                let y = 120;
                const rowH = 7;
                const drawRow = (label, val, unit) => {
                    doc.setFont("helvetica", "normal");
                    doc.text(label, 40, y);
                    doc.setFont("helvetica", "bold");
                    doc.text(val, 110, y, { align: "right" });
                    doc.setFont("helvetica", "normal");
                    if (unit) doc.text(unit, 112, y);
                    y += rowH;
                };

                drawRow("Anschaffungspreis:", preisVal, "€");
                drawRow("Laufzeit:", laufzeitVal, "Monate");
                drawRow("Mietsonderzahlung:", "0,00", "€");
                drawRow("Monatliche Rate:", rateVal, "€");
                const hasPercent = leasingfaktorVal.includes('%');
                drawRow("Rate in %:", hasPercent ? leasingfaktorVal.replace('%','').trim() : leasingfaktorVal, "%");
                drawRow("kalk. Restwert:", restwertEuroVal, "€");

                y += 10;
                if (art === "Mietkauf") {
                    doc.setFont("helvetica", "bold");
                    doc.text("Hinweis: Die gesetzl. Mehrwertsteuer fällt vorab auf die Summe aller Zahlungen an.", 20, y);
                    y += 10;
                }

                doc.setFont("helvetica", "normal");
                doc.text("Die oben genannten Preise verstehen sich netto, zuzüglich der gesetzlichen Mehrwertsteuer.", 20, y);
                y += 15;

                doc.text(["Wir freuen uns, für Sie tätig werden zu können und sichern Ihnen bereits jetzt eine faire, schnelle", 
                          "und unbürokratische Abwicklung zu."], 20, y);
                
                y += 20;
                doc.text("Mit freundlichen Grüßen,", 20, y);
                y += 10;
                doc.setFont("helvetica", "bold");
                doc.text("cardioscan GmbH", 20, y);

                doc.setDrawColor(150, 150, 150);
                doc.setLineWidth(0.2);
                doc.line(20, 270, 190, 270);

                doc.setFontSize(5.5);
                doc.setFont("helvetica", "normal");

                doc.text(["cardioscan GmbH", "Theodorstraße 41", "22761 Hamburg"], 20, 274);
                doc.text(["Geschäftsführer Dr. Marc Weitl", "Amtsgericht Hamburg HRB 117288", "Ust-IdNr. DE268167789"], 46, 274);
                doc.text(["Fon (+49) 40-303 723 30", "info@cardioscan.de", "www.cardioscan.de"], 86, 274);
                
                doc.text(["Sydbank", "Commerzbank"], 118, 274);
                doc.text(["IBAN DE55 2151 0800 1000 6859 59", "IBAN DE33 2004 0000 0630 1527 00"], 136, 274);
                doc.text(["SYBKDE22", "COBADEFFXXX"], 190, 274, { align: "right" });

                const firmaClean = firma.replace(/[^a-zA-Z0-9]/g, '_');
                const filename = `cardioscan_${art}_${firmaClean}.pdf`;
                
                // 1. PDF DOWNLOAD STARTEN (Kunde lädt das PDF lokal herunter)
                doc.save(filename);

                // 2. EMAILJS PARAMETER VORBEREITEN (OHNE ANHANG, ALLE DATEN ALS TEXT)
                const templateParams = {
                    firma_name: firma,
                    kontakt_name: `${anrede} ${vorname} ${nachname}`,
                    adresse: strasse,
                    plz_ort: `${plz} ${ort}`,
                    finanzierungsart: art,
                    anschaffungspreis: preisVal,
                    laufzeit: laufzeitVal,
                    rate: rateVal,
                    leasingfaktor: leasingfaktorVal,
                    restwert: restwertEuroVal
                };

                // 3. E-MAIL ABSENDEN (Du musst SERVICE_ID und TEMPLATE_ID noch anpassen)
                // WICHTIG: Ersetze "DEINE_SERVICE_ID" und "DEINE_TEMPLATE_ID" mit deinen echten IDs von EmailJS
                try {
                    await emailjs.send("service_xyz123", "template_abc890", templateParams);
                    console.log("E-Mail Alert erfolgreich versendet.");
                    // Optional: Erfolgsmeldung für den User anzeigen
                } catch (emailError) {
                    console.error("Fehler beim E-Mail Versand:", emailError);
                    // Wir werfen hier keinen Fehler, damit der User zumindest seine PDF trotzdem bekommt
                }

            } catch (error) {
                console.error("Fehler bei der PDF Generierung:", error);
                alert("Es ist ein Fehler bei der PDF-Generierung aufgetreten. Überprüfen Sie die Konsole.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
